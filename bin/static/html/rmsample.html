<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>渲染模型示例</title>
	<style type="text/css">
		.custom-file-upload {
			display: inline-block;
			padding: 6px 12px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			color: #fff;
			background-color: #337ab7;
			border-color: #2e6da4;
			border-radius: 4px;
		}

		.custom-file-upload:hover {
			background-color: #286090;
			border-color: #204d74;
		}

		input[type="file"] {
			display: none;
		}
	</style>
	<script type="text/javascript">
		console.log("sys init ...");
		let hostUrl = "http://localhost:9090/"
		hostUrl = "/"
		let taskReqSvrUrl = hostUrl + "renderingTask";

		let startTime = Date.now()

		let taskJsonObj = {}
		let taskStatus = 0
		let rt_phase = ""
		let rt_phase_times = 0
		function reset() {
			taskJsonObj = {}
			taskStatus = 0
			rt_phase = ""
			rt_phase_times = 0
		}
		function updatePage() {
			location.reload();
		}
		function taskSuccess(filepath) {
			if (filepath === undefined || filepath == "") {
				filepath = "./static/rtUploadFiles/modelRTask2001/boomBox.glb"
			}
			let i = filepath.lastIndexOf("/")
			let imgDirUrl = hostUrl + filepath.slice(2, i + 1);
			imgUrl = imgDirUrl + "bld_rendering_mini.jpg"
			console.log("imgUrl: ", imgUrl);

			var div = document.getElementById("imgDiv");
			let img = new Image()
			img.src = imgUrl
			div.appendChild(img);
			var br = document.createElement("br");
			div.appendChild(br);

			imgUrl = imgDirUrl + "bld_rendering.jpg"
			var link = document.createElement("a");
			link.setAttribute("href", imgUrl);
			link.setAttribute("target", "_blank");
			link.innerHTML = "下载/查看渲染效果图";
			div.appendChild(link);

			var br = document.createElement("br");
			div.appendChild(br);
			const span = document.createElement('span');
			span.innerHTML = '/\\';
			div.appendChild(span);
			var br = document.createElement("br");
			div.appendChild(br);
			link = document.createElement("a");
			link.innerHTML = "渲染其他模型";
			link.href = "#";
			link.addEventListener("click", updatePage);
			div.appendChild(link);
		}

		function taskFailure() {
			var div = document.getElementById("imgDiv");
			var br = document.createElement("br");
			div.appendChild(br);
			let link = document.createElement("a");
			link.innerHTML = "渲染其他模型";
			link.href = "#";
			link.addEventListener("click", updatePage);
			div.appendChild(link);
		}
		function taskTimeout() {
			var div = document.getElementById("infoDiv");
			div.innerHTML = "渲染任务超时,请重新提交渲染"
			div = document.getElementById("imgDiv");
			var br = document.createElement("br");
			div.appendChild(br);
			let link = document.createElement("a");
			link.innerHTML = "渲染其他模型";
			link.href = "#";
			link.addEventListener("click", updatePage);
			div.appendChild(link);
		}

		function sendCurrentGetReq(purl) {
			let codeLoader = new XMLHttpRequest();
			codeLoader.open("GET", purl, true);
			codeLoader.onerror = function (err) {
				console.error("load error: ", err);
			};
			codeLoader.onprogress = e => { };
			codeLoader.onload = evt => {
				console.log("sendCurrentGetReq(), codeLoader.response: ", codeLoader.response);
			};
			codeLoader.send(null);
		}
		function showSpecInfo(keyStr, times) {

			var div = document.getElementById("infoDiv");
			let flag = times % 3
			switch (flag) {
				case 0:
					div.innerHTML = keyStr + "&nbsp;.&nbsp;&nbsp;"
					break;
				case 1:
					div.innerHTML = keyStr + "&nbsp;..&nbsp;"
					break;
				default:
					div.innerHTML = keyStr + "&nbsp;..."
					break;
			}
		}
		function sendAGetReq(purl) {
			let codeLoader = new XMLHttpRequest();
			codeLoader.open("GET", purl, true);
			codeLoader.onerror = function (err) {
				console.error("load error: ", err);
			};
			codeLoader.onprogress = e => { };
			codeLoader.onload = evt => {
				var sdo = JSON.parse(codeLoader.response);
				console.log("sendAGetReq(), sdo: ", sdo);

				var div = document.getElementById("infoDiv");
				let phase = sdo.phase;
				if (rt_phase != phase) {
					rt_phase = phase
					rt_phase_times = 0
				}
				let keyStr = ""
				let flag = 0
				switch (phase) {
					case "running":
						if(sdo.progress < 6) {
							showSpecInfo("正在解析模型数据", rt_phase_times)
						}else {
							div.innerHTML = "正在进行渲染: " + sdo.progress + "%"
						}
						break;
					case "new":
						keyStr = "排队(" + sdo.teamIndex + ")等待可用渲染器"
						showSpecInfo(keyStr, rt_phase_times)
						break;
					case "task_rendering_enter":
						if (rt_phase_times > 2) {
							showSpecInfo("配置渲染任务", rt_phase_times)
						} else {
							showSpecInfo("启动渲染任务", rt_phase_times)
						}
						break;
					case "task_rendering_load_res":
						showSpecInfo("同步模型资源", rt_phase_times)
						break;
					case "task_rendering_begin":
						showSpecInfo("准备渲染数据", rt_phase_times)
						break;
					case "finish":
						let time_ms = (Date.now() - startTime)
						let time_s = Math.round(time_ms / 1000.0)
						console.log("loss time: ", time_s + "s(" + time_ms + "ms)");
						taskStatus = 1
						div.innerHTML = "渲染结束"
						taskSuccess(taskJsonObj.filepath)
						break;
					case "rtaskerror":
						taskStatus = 2
						div.innerHTML = "渲染失败"
						taskFailure()
					default:
						break;
				}
				rt_phase_times++
			};
			codeLoader.send(null);
		}
		function notifyTaskInfoToSvr(phase, progress, taskId, taskName) {
			let url = taskReqSvrUrl + "?phase=" + phase + "&progress=" + progress
			if (taskId > 0) {
				url += "&taskid=" + taskId + "&taskname=" + taskName
			}
			sendAGetReq(url)
		}

		let ptupdateTimes = 2100
		let timeoutId = -1;
		function ptupdate() {

			if (timeoutId > -1) {
				clearTimeout(timeoutId);
			}
			// console.log("ptupdate() ... taskJsonObj: ", taskJsonObj)
			if (taskStatus < 1) {
				notifyTaskInfoToSvr("queryataskrst", 0, taskJsonObj.taskid, taskJsonObj.taskname)
				ptupdateTimes--;
				if (ptupdateTimes > 0) {
					timeoutId = setTimeout(ptupdate, 800);
				} else {

				}
			} else {
				console.log("task finish !!!!")
			}
		}

		var xhr;
		function uploadAFile() {
			var url = "http://localhost:9090/uploadRTData?phase=newrtask";
			console.log("UpladFile() call ...url: ", url);
			var fileObj = document.getElementById("file_select").files[0];
			console.log("fileObj: ", fileObj);
			if (!fileObj) {
				alert("the file dosen't exist !!!");
				return;
			}
			var form = new FormData();
			form.append("file", fileObj);

			xhr = new XMLHttpRequest();
			xhr.open("post", url, true);
			xhr.onload = uploadComplete;
			xhr.onerror = uploadFailed;

			xhr.upload.onprogress = progressFunction;
			xhr.upload.onloadstart = function () {
				ot = new Date().getTime();
				oloaded = 0;
			};

			xhr.send(form);
		}

		function uploadComplete(evt) {

			let str = evt.target.responseText + "";
			console.log("evt.target.responseText: ", str);
			var data = JSON.parse(str);
			console.log("josn obj data: ", data);
			if (data.success) {
				taskJsonObj = data
				console.log("上传成功！");
				// alert("上传成功！");
				ptupdate();
			} else {
				alert("上传失败！");
			}
		}
		function uploadFailed(evt) {
			alert("上传失败！");
		}
		function cancleUploadFile() {
			xhr.abort();
		}

		function progressFunction(evt) {
			var progressBar = document.getElementById("progressBar");
			var percentageDiv = document.getElementById("percentage");

			if (evt.lengthComputable) {
				progressBar.max = evt.total;
				progressBar.value = evt.loaded;
				percentageDiv.innerHTML = Math.round(evt.loaded / evt.total * 100) + "%";
			}
			var time = document.getElementById("time");
			var nt = new Date().getTime();
			var pertime = (nt - ot) / 1000;
			ot = new Date().getTime();
			var perload = evt.loaded - oloaded;
			oloaded = evt.loaded;

			var speed = perload / pertime;
			var bspeed = speed;
			var units = 'B/s';
			if (speed / 1024 > 1) {
				speed = speed / 1024;
				units = 'K/s';
			}
			if (speed / 1024 > 1) {
				speed = speed / 1024;
				units = 'M/s';
			}
			speed = speed.toFixed(1);
			var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);
			time.innerHTML = '上传速度：' + speed + units + '，剩余时间：' + resttime + 's';
			if (bspeed == 0) time.innerHTML = '上传已取消';
		}
	</script>
</head>

<body>
	<center />
	<br />
	<progress id="progressBar" value="0" max="100" style="width: 300px;"></progress>
	<br />
	<span id="percentage"></span>
	<br />
	<span id="time"></span>

	<div id="select_file_div">
		<label id="file_select_label" for="file_select" class="custom-file-upload">
			<i class="fa fa-cloud-upload"></i> 选择模型文件
		</label>
		<input type="file" id="file_select" accept=".glb,.fbx,.obj" readonly="readonly" name="myfile" value="上传渲染模型" />
	</div>
	<br />
	<br />
	<div id="infoDiv">
	</div>
	<br />
	<div id="imgDiv">
	</div>
	<script type="text/javascript">
		var inputObj = document.getElementById("file_select")
		inputObj.addEventListener("change", () => {
			uploadAFile()
			let div = document.getElementById("select_file_div")
			div.parentNode.removeChild(div);
		});
	</script>
</body>

</html>