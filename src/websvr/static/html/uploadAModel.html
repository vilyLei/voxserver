<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>XMLHttpRequest上传文件</title>
    <script type="text/javascript">
		console.log("sys init ...");
        let hostUrl = "http://localhost:9090/"
		let taskReqSvrUrl = hostUrl + "renderingTask";

		let taskJsonObj = {}

        // filepath = "./static/rtUploadFiles/modelRTask2001/boomBox.glb"
        // let i = filepath.lastIndexOf("/")
        // imgUrl = hostUrl + filepath.slice(2, i+1) + "bld_rendering_mini.jpg"
        // console.log("imgUrl: ", imgUrl);

        function addMiniImg(filepath) {
            if(filepath === undefined || filepath == "") {
                filepath = "./static/rtUploadFiles/modelRTask2001/boomBox.glb"
            }
            let i = filepath.lastIndexOf("/")
            imgUrl = hostUrl + filepath.slice(2, i+1) + "bld_rendering_mini.jpg"
            console.log("imgUrl: ", imgUrl);

            var div = document.getElementById("imgDiv");
            let img = new Image()
            img.src = imgUrl
            div.appendChild(img);
        }

		let taskStatus = 0
		function sendAGetReq(purl) {
			let codeLoader = new XMLHttpRequest();
			codeLoader.open("GET", purl, true);
			codeLoader.onerror = function(err) {
				console.error("load error: ", err);
			};
			codeLoader.onprogress = e => {};
			codeLoader.onload = evt => {
				// console.log("sendAGetReq(), codeLoader.response: ", codeLoader.response);
				var sendAGetReq_data = JSON.parse(codeLoader.response);
				console.log("sendAGetReq(), sendAGetReq_data: ", sendAGetReq_data);
                // task_rendering_enter
                
				var div = document.getElementById("infoDiv");
                let phase = sendAGetReq_data.phase;
                switch(phase) {
                    case "running":
                        div.innerHTML = "task progress: " + sendAGetReq_data.progress + "%"
                        break;
                    case "new":
                        div.innerHTML = "waiting a renderer ..."
                        break;
                    case "task_rendering_enter":
                        div.innerHTML = "enter a renderer ..."
                        break;
                    case "finish":
                        taskStatus = 1
                        div.innerHTML = "rendering task finish !!!"
                        addMiniImg(taskJsonObj.filepath)
                        // let i = filepath.lastIndexof("/")
                        // imgUrl = filepath.slice(0, i) + "bld_rendering_mini.jpg"
                        //bld_rendering_mini.jpg
                    default:
                        break;
                }
			};
			codeLoader.send(null);
		}
		function notifyTaskInfoToSvr(phase, progress, taskId, taskName) {
			let url = taskReqSvrUrl + "?phase=" + phase + "&progress=" + progress
			if (taskId > 0) {
				url += "&taskid=" + taskId + "&taskname=" + taskName
			}
			sendAGetReq(url)
		}

		let ptupdateTimes = 63
		let timeoutId = -1;
		function ptupdate() {

			if (timeoutId > -1) {
				clearTimeout(timeoutId);
			}
			// console.log("ptupdate() ... taskJsonObj: ", taskJsonObj)
			if(taskStatus < 1) {
				notifyTaskInfoToSvr("queryataskrst", 0, taskJsonObj.taskid, taskJsonObj.taskname)
				ptupdateTimes --;
				if(ptupdateTimes > 0) {
					timeoutId = setTimeout(ptupdate, 800);
				}
			}else {
				console.log("task finin OK !!!!")
			}
		}
        //图片上传
        var xhr;
        //上传文件方法
        function test() {
			console.log("test");
		}
        function uploadAFile() {
            var url =  "http://localhost:9090/uploadRTData?phase=newrtask"; // 接收上传文件的后台地址
			console.log("UpladFile() call ...url: ", url);
            var fileObj = document.getElementById("file").files[0]; // js 获取文件对象
			console.log("fileObj: ", fileObj);
			if(!fileObj) {
				alert("the file dosen't exist !!!");
				return;
			}
            var form = new FormData(); // FormData 对象
            form.append("file", fileObj); // 文件对象

            xhr = new XMLHttpRequest();  // XMLHttpRequest 对象
            xhr.open("post", url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
            xhr.onload = uploadComplete; //请求完成
            xhr.onerror =  uploadFailed; //请求失败

            xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
            xhr.upload.onloadstart = function(){//上传开始执行方法
                ot = new Date().getTime();   //设置上传开始时间
                oloaded = 0;//设置上传开始时，以上传的文件大小为0
            };

            xhr.send(form); //开始上传，发送form数据
        }

        // 上传成功响应
        function uploadComplete(evt) {

            // 服务断接收完文件返回的结果
			let str = evt.target.responseText + "";
			console.log("evt.target.responseText: ", str);
            var data = JSON.parse(str);
			console.log("josn obj data: ", data);
            if(data.success) {
				taskJsonObj = data
                alert("上传成功！");
				ptupdate();
            }else{
                alert("上传失败！");
            }
        }
        //上传失败
        function uploadFailed(evt) {
            alert("上传失败！");
        }
        //取消上传
        function cancleUploadFile(){
			console.log("cancleUploadFile() call ...");
            xhr.abort();
        }


        //上传进度实现方法，上传过程中会频繁调用该方法
        function progressFunction(evt) {
			console.log("progressFunction() call ...");
            var progressBar = document.getElementById("progressBar");
            var percentageDiv = document.getElementById("percentage");
            // event.total是需要传输的总字节，event.loaded是已经传输的字节。如果event.lengthComputable不为真，则event.total等于0
            if (evt.lengthComputable) {//
                progressBar.max = evt.total;
                progressBar.value = evt.loaded;
                percentageDiv.innerHTML = Math.round(evt.loaded / evt.total * 100) + "%";
            }
            var time = document.getElementById("time");
            var nt = new Date().getTime();//获取当前时间
            var pertime = (nt-ot)/1000; //计算出上次调用该方法时到现在的时间差，单位为s
            ot = new Date().getTime(); //重新赋值时间，用于下次计算
            var perload = evt.loaded - oloaded; //计算该分段上传的文件大小，单位b
            oloaded = evt.loaded;//重新赋值已上传文件大小，用以下次计算
            //上传速度计算
            var speed = perload/pertime;//单位b/s
            var bspeed = speed;
            var units = 'b/s';//单位名称
            if(speed/1024>1){
                speed = speed/1024;
                units = 'k/s';
            }
            if(speed/1024>1){
                speed = speed/1024;
                units = 'M/s';
            }
            speed = speed.toFixed(1);
            //剩余时间
            var resttime = ((evt.total-evt.loaded)/bspeed).toFixed(1);
            time.innerHTML = '，速度：'+speed+units+'，剩余时间：'+resttime+'s';
            if(bspeed==0) time.innerHTML = '上传已取消';
        }
    </script>
</head>
<body>
<progress id="progressBar" value="0" max="100" style="width: 300px;"></progress>
<span id="percentage"></span><span id="time"></span>
<br /><br />
<input type="file" id="file" accept=".glb,.fbx,.obj" name="myfile"/>
<!--
	<input type="file" id="files" multiple/><br/><br/>
<input type="button" οnclick="alert('dd')" value="上传" />
<input type="button" οnclick="cancleUploadFile()" value="取消" />
-->
<button id="target0" onclick="uploadAFile()">上传</button>
<button id="target1" onclick="cancleUploadFile()">取消上传</button>
<button id="target" onclick="test()">test</button>
<br/>
<br/>
<div id="infoDiv">
	task waiting ...
</div>
<br/>
<div id="imgDiv">
	...
</div>
<script type="text/javascript">
    // addMiniImg("")
</script>
</body>
</html>